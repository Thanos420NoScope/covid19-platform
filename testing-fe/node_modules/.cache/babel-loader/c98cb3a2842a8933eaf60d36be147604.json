{"ast":null,"code":"var _jsxFileName = \"/Users/francescomelpignano/Desktop/kadena/code/covid19-kda/frontend/src/contexts/PactCallContext.js\";\nimport React from 'react';\nimport Pact from 'pact-lang-api';\n\nvar hash = require('object-hash');\n\nconst config = require('../config.json');\n\nconst Context = React.createContext();\nconst hosts = [\"us1\", \"us2\"];\n\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`;\n\nexport class PactCallStore extends React.Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      testInfo: {},\n      loading: false\n    };\n\n    this.wait = async timeout => {\n      return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n      });\n    };\n\n    this.getTest = async pubKey => {\n      await this.setState({\n        loading: true\n      });\n      const res = await Pact.fetch.local({\n        networkId: \"testnet04\",\n        // pactCode:`(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        pactCode: `(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"dummy-local\", \"0\", 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], \"0\"));\n\n      if (res.result.status === \"success\") {\n        await this.setState({\n          testInfo: res.result.data\n        });\n        await this.setState({\n          loading: false\n        });\n        return res.result.data;\n      } else {\n        await this.setState({\n          testInfo: \"failure\"\n        });\n        await this.setState({\n          loading: false\n        });\n        return \"failure\";\n      }\n    };\n\n    this.administerTest = async (pubKey, privKey, chainId, ageGroup, gender, name, surname, dob, id) => {\n      await this.setState({\n        loading: true\n      });\n      const patientJSON = {\n        name: name,\n        surname: surname,\n        dob: dob,\n        id: id\n      };\n      const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode: `(user.covid.administer-test ${JSON.stringify(pubKey)} ${JSON.stringify(ageGroup)} ${JSON.stringify(gender)} ${JSON.stringify(hash(patientJSON))})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }, {\n          publicKey: pubKey,\n          secretKey: privKey,\n          clist: {\n            name: \"user.covid.REGISTERED-TEST\",\n            args: [pubKey]\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"covid-admin\", \"0\", 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (reqKey) {\n        //check kadena tx status every 10 seconds until we get a response (success or fail)\n        var time = 180;\n        var pollRes;\n\n        while (time > 0) {\n          await this.wait(10000);\n          pollRes = await Pact.fetch.poll({\n            requestKeys: [reqKey.requestKeys[0]]\n          }, createAPIHost(hosts[0], \"0\"));\n\n          if (Object.keys(pollRes).length === 0) {\n            console.log('no return poll');\n            console.log(pollRes);\n            time = time - 10;\n          } else {\n            console.log(pollRes);\n            time = 0;\n          }\n        } //tx successful\n\n\n        if (pollRes[reqKey.requestKeys[0]].result.status === \"success\") {\n          //doc registered on blockchain, now add to db\n          await this.setState({\n            loading: false\n          });\n          alert(\"The test was successfuly registered on Kadena mainnet\"); //SHOW A MESSAGE OF SUCCESS\n\n          window.location.reload(); //tx unsuccessful\n        } else {\n          alert(\"there was a problem processing your transaction on Kadena mainnet\");\n          window.location.reload();\n        }\n      } else {\n        //blockchain call had formatting issues\n        alert(\"there was a problem processing your transaction on Kadena mainnet\");\n        window.location.reload();\n      }\n    };\n  }\n\n  render() {\n    return React.createElement(Context.Provider, {\n      value: { ...this.state,\n        getTest: this.getTest,\n        administerTest: this.administerTest\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 93\n      },\n      __self: this\n    }, this.props.children);\n  }\n\n}\nexport default Context;","map":{"version":3,"sources":["/Users/francescomelpignano/Desktop/kadena/code/covid19-kda/frontend/src/contexts/PactCallContext.js"],"names":["React","Pact","hash","require","config","Context","createContext","hosts","createAPIHost","network","chainId","PactCallStore","Component","state","testInfo","loading","wait","timeout","Promise","resolve","setTimeout","getTest","pubKey","setState","res","fetch","local","networkId","pactCode","JSON","stringify","keyPairs","covidAdminKeys","clist","name","args","meta","lang","mkMeta","Math","round","Date","getTime","result","status","data","administerTest","privKey","ageGroup","gender","surname","dob","id","patientJSON","reqKey","send","publicKey","secretKey","time","pollRes","poll","requestKeys","Object","keys","length","console","log","alert","window","location","reload","render","props","children"],"mappings":"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","sourcesContent":["import React from 'react';\nimport Pact from 'pact-lang-api';\nvar hash = require('object-hash');\nconst config = require('../config.json')\n\nconst Context = React.createContext();\n\nconst hosts = [\"us1\", \"us2\"]\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`\n\nexport class PactCallStore extends React.Component {\n\n  state = {\n    testInfo: {},\n    loading: false\n  }\n\n  wait = async (timeout) => {\n    return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n    });\n  }\n\n  getTest = async (pubKey) => {\n    await this.setState({ loading: true })\n    const res = await Pact.fetch.local({\n        networkId: \"testnet04\",\n        // pactCode:`(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        pactCode: `(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}],\n        meta: Pact.lang.mkMeta(\"dummy-local\",\"0\",0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], \"0\"))\n    if (res.result.status === \"success\") {\n      await this.setState({ testInfo: res.result.data })\n      await this.setState({ loading: false })\n      return res.result.data;\n    } else {\n      await this.setState({ testInfo: \"failure\" })\n      await this.setState({ loading: false })\n      return \"failure\"\n    }\n  }\n\n  administerTest = async (pubKey, privKey, chainId, ageGroup, gender, name, surname, dob, id) => {\n    await this.setState({ loading: true })\n    const patientJSON = {\n      name: name,\n      surname: surname,\n      dob: dob,\n      id: id\n    }\n    const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode:`(user.covid.administer-test ${JSON.stringify(pubKey)} ${JSON.stringify(ageGroup)} ${JSON.stringify(gender)} ${JSON.stringify(hash(patientJSON))})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}, {publicKey: pubKey, secretKey: privKey, clist: {name: \"user.covid.REGISTERED-TEST\", args: [pubKey]}}],\n        meta: Pact.lang.mkMeta(\"covid-admin\",\"0\",0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId));\n        if (reqKey) {\n          //check kadena tx status every 10 seconds until we get a response (success or fail)\n          var time = 180;\n          var pollRes;\n          while (time > 0) {\n            await this.wait(10000);\n            pollRes = await Pact.fetch.poll({requestKeys: [reqKey.requestKeys[0]]}, createAPIHost(hosts[0], \"0\"));\n            if (Object.keys(pollRes).length === 0) {\n              console.log('no return poll');\n              console.log(pollRes)\n              time = time - 10\n            } else {\n              console.log(pollRes);\n              time = 0;\n            }\n          }\n          //tx successful\n          if (pollRes[reqKey.requestKeys[0]].result.status === \"success\"){\n            //doc registered on blockchain, now add to db\n            await this.setState({loading: false})\n            alert(\"The test was successfuly registered on Kadena mainnet\")\n            //SHOW A MESSAGE OF SUCCESS\n            window.location.reload();\n          //tx unsuccessful\n          } else {\n            alert(\"there was a problem processing your transaction on Kadena mainnet\")\n            window.location.reload();\n          }\n        } else {\n          //blockchain call had formatting issues\n          alert(\"there was a problem processing your transaction on Kadena mainnet\")\n          window.location.reload();\n        }\n  }\n\n  render() {\n    return (\n      <Context.Provider\n        value={{\n          ...this.state,\n          getTest: this.getTest,\n          administerTest: this.administerTest\n        }}\n      >\n        {this.props.children}\n      </Context.Provider>\n    );\n  }\n\n}\n\nexport default Context;\n"]},"metadata":{},"sourceType":"module"}