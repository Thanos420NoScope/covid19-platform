{"ast":null,"code":"var _jsxFileName = \"/Users/francescomelpignano/Desktop/kadena/code/covid19-kda/frontend/src/contexts/PactCallContext.js\";\nimport React from 'react';\nimport Pact from 'pact-lang-api';\n\nvar hash = require('object-hash');\n\nconst config = require('../config.json');\n\nconst Context = React.createContext();\nconst hosts = [\"us1\", \"us2\"];\n\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`;\n\nexport class PactCallStore extends React.Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      testInfo: {},\n      txData: {},\n      loading: false,\n      txStatus: \"\",\n      screen: \"welcome\"\n    };\n\n    this.wait = async timeout => {\n      return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n      });\n    };\n\n    this.getTest = async (pubKey, chainId) => {\n      await this.setState({\n        loading: true\n      });\n      const res = await Pact.fetch.local({\n        networkId: \"testnet04\",\n        // pactCode:`(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        pactCode: `(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"dummy-local\", chainId, 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (res.result.status === \"success\") {\n        await this.setState({\n          testInfo: res.result.data\n        });\n        await this.setState({\n          loading: false\n        });\n        return res.result.data;\n      } else {\n        await this.setState({\n          testInfo: \"failure\"\n        });\n        await this.setState({\n          loading: false\n        });\n        return \"failure\";\n      }\n    };\n\n    this.administerTest = async (pubKey, privKey, chainId, ageGroup, gender, name, surname, dob, id) => {\n      await this.setState({\n        loading: true\n      });\n      const patientJSON = {\n        name: name,\n        surname: surname,\n        dob: dob,\n        id: id\n      };\n      const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode: `(user.covid.administer-test ${JSON.stringify(pubKey)} ${JSON.stringify(ageGroup)} ${JSON.stringify(gender)} ${JSON.stringify(hash(patientJSON))})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }, {\n          publicKey: pubKey,\n          secretKey: privKey,\n          clist: {\n            name: \"user.covid.REGISTERED-TEST\",\n            args: [pubKey]\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"covid-admin\", chainId, 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (reqKey) {\n        //check kadena tx status every 10 seconds until we get a response (success or fail)\n        var time = 180;\n        var pollRes;\n\n        while (time > 0) {\n          await this.wait(10000);\n          pollRes = await Pact.fetch.poll({\n            requestKeys: [reqKey.requestKeys[0]]\n          }, createAPIHost(hosts[0], chainId));\n\n          if (Object.keys(pollRes).length === 0) {\n            console.log('no return poll');\n            console.log(pollRes);\n            time = time - 10;\n          } else {\n            console.log(pollRes);\n            time = 0;\n          }\n        } //tx successful\n\n\n        if (pollRes[reqKey.requestKeys[0]].result.status === \"success\") {\n          //doc registered on blockchain, now add to db\n          await this.setState({\n            loading: false,\n            txStatus: 'success',\n            txData: pollRes[reqKey.requestKeys[0]]\n          }); // alert(\"The test was successfuly registered on Kadena mainnet\")\n          //SHOW A MESSAGE OF SUCCESS\n          // window.location.reload();\n          //tx unsuccessful\n        } else {\n          await this.setState({\n            loading: false,\n            txStatus: 'failure',\n            txData: pollRes[reqKey.requestKeys[0]]\n          }); // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n          // window.location.reload();\n        }\n      } else {\n        //blockchain call had formatting issues\n        await this.setState({\n          loading: false,\n          txStatus: 'failure',\n          txData: pollRes[reqKey.requestKeys[0]]\n        }); // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n        // window.location.reload();\n      }\n    };\n\n    this.endTest = async (pubKey, privKey, chainId, result) => {\n      await this.setState({\n        loading: true\n      });\n      const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode: `(user.covid.end-test ${JSON.stringify(pubKey)} ${JSON.stringify(result)})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }, {\n          publicKey: pubKey,\n          secretKey: privKey,\n          clist: {\n            name: \"user.covid.REGISTERED-TEST\",\n            args: [pubKey]\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"covid-admin\", chainId, 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (reqKey) {\n        //check kadena tx status every 10 seconds until we get a response (success or fail)\n        var time = 180;\n        var pollRes;\n\n        while (time > 0) {\n          await this.wait(10000);\n          pollRes = await Pact.fetch.poll({\n            requestKeys: [reqKey.requestKeys[0]]\n          }, createAPIHost(hosts[0], chainId));\n\n          if (Object.keys(pollRes).length === 0) {\n            console.log('no return poll');\n            console.log(pollRes);\n            time = time - 10;\n          } else {\n            console.log(pollRes);\n            time = 0;\n          }\n        } //tx successful\n\n\n        if (pollRes[reqKey.requestKeys[0]].result.status === \"success\") {\n          //doc registered on blockchain, now add to db\n          await this.setState({\n            loading: false,\n            txStatus: 'success',\n            txData: pollRes[reqKey.requestKeys[0]]\n          }); //tx unsuccessful\n        } else {\n          await this.setState({\n            loading: false,\n            txStatus: 'failure',\n            txData: pollRes[reqKey.requestKeys[0]]\n          });\n        }\n      } else {\n        //blockchain call had formatting issues\n        await this.setState({\n          loading: false,\n          txStatus: 'failure',\n          txData: pollRes[reqKey.requestKeys[0]]\n        });\n      }\n    };\n  }\n\n  render() {\n    return React.createElement(Context.Provider, {\n      value: { ...this.state,\n        getTest: this.getTest,\n        administerTest: this.administerTest,\n        endTest: this.endTest\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 136\n      },\n      __self: this\n    }, this.props.children);\n  }\n\n}\nexport default Context;","map":{"version":3,"sources":["/Users/francescomelpignano/Desktop/kadena/code/covid19-kda/frontend/src/contexts/PactCallContext.js"],"names":["React","Pact","hash","require","config","Context","createContext","hosts","createAPIHost","network","chainId","PactCallStore","Component","state","testInfo","txData","loading","txStatus","screen","wait","timeout","Promise","resolve","setTimeout","getTest","pubKey","setState","res","fetch","local","networkId","pactCode","JSON","stringify","keyPairs","covidAdminKeys","clist","name","args","meta","lang","mkMeta","Math","round","Date","getTime","result","status","data","administerTest","privKey","ageGroup","gender","surname","dob","id","patientJSON","reqKey","send","publicKey","secretKey","time","pollRes","poll","requestKeys","Object","keys","length","console","log","endTest","render","props","children"],"mappings":"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","sourcesContent":["import React from 'react';\nimport Pact from 'pact-lang-api';\nvar hash = require('object-hash');\nconst config = require('../config.json')\n\nconst Context = React.createContext();\n\nconst hosts = [\"us1\", \"us2\"]\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`\n\nexport class PactCallStore extends React.Component {\n\n  state = {\n    testInfo: {},\n    txData: {},\n    loading: false,\n    txStatus: \"\",\n    screen: \"welcome\"\n  }\n\n  wait = async (timeout) => {\n    return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n    });\n  }\n\n  getTest = async (pubKey, chainId) => {\n    await this.setState({ loading: true })\n    const res = await Pact.fetch.local({\n        networkId: \"testnet04\",\n        // pactCode:`(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        pactCode: `(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}],\n        meta: Pact.lang.mkMeta(\"dummy-local\",chainId,0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId))\n    if (res.result.status === \"success\") {\n      await this.setState({ testInfo: res.result.data })\n      await this.setState({ loading: false })\n      return res.result.data;\n    } else {\n      await this.setState({ testInfo: \"failure\" })\n      await this.setState({ loading: false })\n      return \"failure\"\n    }\n  }\n\n  administerTest = async (pubKey, privKey, chainId, ageGroup, gender, name, surname, dob, id) => {\n    await this.setState({ loading: true })\n    const patientJSON = {\n      name: name,\n      surname: surname,\n      dob: dob,\n      id: id\n    }\n    const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode:`(user.covid.administer-test ${JSON.stringify(pubKey)} ${JSON.stringify(ageGroup)} ${JSON.stringify(gender)} ${JSON.stringify(hash(patientJSON))})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}, {publicKey: pubKey, secretKey: privKey, clist: {name: \"user.covid.REGISTERED-TEST\", args: [pubKey]}}],\n        meta: Pact.lang.mkMeta(\"covid-admin\",chainId,0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId));\n        if (reqKey) {\n          //check kadena tx status every 10 seconds until we get a response (success or fail)\n          var time = 180;\n          var pollRes;\n          while (time > 0) {\n            await this.wait(10000);\n            pollRes = await Pact.fetch.poll({requestKeys: [reqKey.requestKeys[0]]}, createAPIHost(hosts[0], chainId));\n            if (Object.keys(pollRes).length === 0) {\n              console.log('no return poll');\n              console.log(pollRes)\n              time = time - 10\n            } else {\n              console.log(pollRes);\n              time = 0;\n            }\n          }\n          //tx successful\n          if (pollRes[reqKey.requestKeys[0]].result.status === \"success\"){\n            //doc registered on blockchain, now add to db\n            await this.setState({loading: false, txStatus: 'success', txData: pollRes[reqKey.requestKeys[0]]})\n            // alert(\"The test was successfuly registered on Kadena mainnet\")\n            //SHOW A MESSAGE OF SUCCESS\n            // window.location.reload();\n          //tx unsuccessful\n          } else {\n            await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n            // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n            // window.location.reload();\n          }\n        } else {\n          //blockchain call had formatting issues\n          await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n          // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n          // window.location.reload();\n        }\n  }\n\n  endTest = async (pubKey, privKey, chainId, result) => {\n    await this.setState({ loading: true })\n    const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode:`(user.covid.end-test ${JSON.stringify(pubKey)} ${JSON.stringify(result)})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}, {publicKey: pubKey, secretKey: privKey, clist: {name: \"user.covid.REGISTERED-TEST\", args: [pubKey]}}],\n        meta: Pact.lang.mkMeta(\"covid-admin\",chainId,0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId));\n        if (reqKey) {\n          //check kadena tx status every 10 seconds until we get a response (success or fail)\n          var time = 180;\n          var pollRes;\n          while (time > 0) {\n            await this.wait(10000);\n            pollRes = await Pact.fetch.poll({requestKeys: [reqKey.requestKeys[0]]}, createAPIHost(hosts[0], chainId));\n            if (Object.keys(pollRes).length === 0) {\n              console.log('no return poll');\n              console.log(pollRes)\n              time = time - 10\n            } else {\n              console.log(pollRes);\n              time = 0;\n            }\n          }\n          //tx successful\n          if (pollRes[reqKey.requestKeys[0]].result.status === \"success\"){\n            //doc registered on blockchain, now add to db\n            await this.setState({loading: false, txStatus: 'success', txData: pollRes[reqKey.requestKeys[0]]})\n          //tx unsuccessful\n          } else {\n            await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n          }\n        } else {\n          //blockchain call had formatting issues\n          await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n        }\n  }\n\n\n  render() {\n    return (\n      <Context.Provider\n        value={{\n          ...this.state,\n          getTest: this.getTest,\n          administerTest: this.administerTest,\n          endTest: this.endTest\n        }}\n      >\n        {this.props.children}\n      </Context.Provider>\n    );\n  }\n\n}\n\nexport default Context;\n"]},"metadata":{},"sourceType":"module"}