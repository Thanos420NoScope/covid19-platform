{"ast":null,"code":"var _jsxFileName = \"/Users/francescomelpignano/Desktop/kadena/code/covid19-kda/frontend/src/contexts/PactCallContext.js\";\nimport React from 'react';\nimport Pact from 'pact-lang-api';\n\nvar hash = require('object-hash');\n\nconst config = require('../config.json');\n\nconst Context = React.createContext();\nconst hosts = [\"us1\", \"us2\"];\n\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`;\n\nexport class PactCallStore extends React.Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      testInfo: {},\n      txData: {},\n      loading: false,\n      txStatus: \"\",\n      screen: \"welcome\"\n    };\n\n    this.wait = async timeout => {\n      return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n      });\n    };\n\n    this.setScreen = async name => {\n      await this.setState({\n        screen: name\n      });\n    };\n\n    this.getTest = async (pubKey, chainId) => {\n      await this.setState({\n        loading: true\n      });\n      const res = await Pact.fetch.local({\n        networkId: \"testnet04\",\n        // pactCode:`(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        pactCode: `(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"dummy-local\", chainId, 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (res.result.status === \"success\") {\n        await this.setState({\n          testInfo: res.result.data\n        });\n        await this.setState({\n          loading: false\n        });\n        return res.result.data;\n      } else {\n        await this.setState({\n          testInfo: \"failure\"\n        });\n        await this.setState({\n          loading: false\n        });\n        return \"failure\";\n      }\n    };\n\n    this.administerTest = async (pubKey, privKey, chainId, ageGroup, gender, name, surname, dob, id) => {\n      await this.setState({\n        loading: true\n      });\n      const patientJSON = {\n        name: name,\n        surname: surname,\n        dob: dob,\n        id: id\n      };\n      const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode: `(user.covid.administer-test ${JSON.stringify(pubKey)} ${JSON.stringify(ageGroup)} ${JSON.stringify(gender)} ${JSON.stringify(\"US\")} ${JSON.stringify(\"11249\")} ${JSON.stringify(hash(patientJSON))})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }, {\n          publicKey: pubKey,\n          secretKey: privKey,\n          clist: {\n            name: \"user.covid.REGISTERED-TEST\",\n            args: [pubKey]\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"covid-admin\", chainId, 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (reqKey) {\n        //check kadena tx status every 10 seconds until we get a response (success or fail)\n        var time = 180;\n        var pollRes;\n\n        while (time > 0) {\n          await this.wait(10000);\n          pollRes = await Pact.fetch.poll({\n            requestKeys: [reqKey.requestKeys[0]]\n          }, createAPIHost(hosts[0], chainId));\n\n          if (Object.keys(pollRes).length === 0) {\n            console.log('no return poll');\n            console.log(pollRes);\n            time = time - 10;\n          } else {\n            console.log(pollRes);\n            time = 0;\n          }\n        } //tx successful\n\n\n        if (pollRes[reqKey.requestKeys[0]].result.status === \"success\") {\n          //doc registered on blockchain, now add to db\n          await this.setState({\n            loading: false,\n            txStatus: 'success',\n            txData: pollRes[reqKey.requestKeys[0]]\n          }); // alert(\"The test was successfuly registered on Kadena mainnet\")\n          //SHOW A MESSAGE OF SUCCESS\n          // window.location.reload();\n          //tx unsuccessful\n        } else {\n          await this.setState({\n            loading: false,\n            txStatus: 'failure',\n            txData: pollRes[reqKey.requestKeys[0]]\n          }); // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n          // window.location.reload();\n        }\n      } else {\n        //blockchain call had formatting issues\n        await this.setState({\n          loading: false,\n          txStatus: 'failure',\n          txData: pollRes[reqKey.requestKeys[0]]\n        }); // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n        // window.location.reload();\n      }\n    };\n\n    this.endTest = async (pubKey, privKey, chainId, result) => {\n      await this.setState({\n        loading: true\n      });\n      const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode: `(user.covid.end-test ${JSON.stringify(pubKey)} ${JSON.stringify(result)})`,\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }, {\n          publicKey: pubKey,\n          secretKey: privKey,\n          clist: {\n            name: \"user.covid.REGISTERED-TEST\",\n            args: [pubKey]\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"covid-admin\", chainId, 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800)\n      }, createAPIHost(hosts[0], chainId));\n\n      if (reqKey) {\n        //check kadena tx status every 10 seconds until we get a response (success or fail)\n        var time = 180;\n        var pollRes;\n\n        while (time > 0) {\n          await this.wait(10000);\n          pollRes = await Pact.fetch.poll({\n            requestKeys: [reqKey.requestKeys[0]]\n          }, createAPIHost(hosts[0], chainId));\n\n          if (Object.keys(pollRes).length === 0) {\n            console.log('no return poll');\n            console.log(pollRes);\n            time = time - 10;\n          } else {\n            console.log(pollRes);\n            time = 0;\n          }\n        } //tx successful\n\n\n        if (pollRes[reqKey.requestKeys[0]].result.status === \"success\") {\n          //doc registered on blockchain, now add to db\n          await this.setState({\n            loading: false,\n            txStatus: 'success',\n            txData: pollRes[reqKey.requestKeys[0]]\n          }); //tx unsuccessful\n        } else {\n          await this.setState({\n            loading: false,\n            txStatus: 'failure',\n            txData: pollRes[reqKey.requestKeys[0]]\n          });\n        }\n      } else {\n        //blockchain call had formatting issues\n        await this.setState({\n          loading: false,\n          txStatus: 'failure',\n          txData: pollRes[reqKey.requestKeys[0]]\n        });\n      }\n    };\n  }\n\n  render() {\n    return React.createElement(Context.Provider, {\n      value: { ...this.state,\n        getTest: this.getTest,\n        administerTest: this.administerTest,\n        endTest: this.endTest,\n        setScreen: this.setScreen\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 140\n      },\n      __self: this\n    }, this.props.children);\n  }\n\n}\nexport default Context;","map":{"version":3,"sources":["/Users/francescomelpignano/Desktop/kadena/code/covid19-kda/frontend/src/contexts/PactCallContext.js"],"names":["React","Pact","hash","require","config","Context","createContext","hosts","createAPIHost","network","chainId","PactCallStore","Component","state","testInfo","txData","loading","txStatus","screen","wait","timeout","Promise","resolve","setTimeout","setScreen","name","setState","getTest","pubKey","res","fetch","local","networkId","pactCode","JSON","stringify","keyPairs","covidAdminKeys","clist","args","meta","lang","mkMeta","Math","round","Date","getTime","result","status","data","administerTest","privKey","ageGroup","gender","surname","dob","id","patientJSON","reqKey","send","publicKey","secretKey","time","pollRes","poll","requestKeys","Object","keys","length","console","log","endTest","render","props","children"],"mappings":"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","sourcesContent":["import React from 'react';\nimport Pact from 'pact-lang-api';\nvar hash = require('object-hash');\nconst config = require('../config.json')\n\nconst Context = React.createContext();\n\nconst hosts = [\"us1\", \"us2\"]\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`\n\nexport class PactCallStore extends React.Component {\n\n  state = {\n    testInfo: {},\n    txData: {},\n    loading: false,\n    txStatus: \"\",\n    screen: \"welcome\"\n  }\n\n  wait = async (timeout) => {\n    return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n    });\n  }\n\n  setScreen = async (name) => {\n    await this.setState({ screen: name });\n  }\n\n  getTest = async (pubKey, chainId) => {\n    await this.setState({ loading: true })\n    const res = await Pact.fetch.local({\n        networkId: \"testnet04\",\n        // pactCode:`(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        pactCode: `(user.covid.get-record ${JSON.stringify(pubKey)})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}],\n        meta: Pact.lang.mkMeta(\"dummy-local\",chainId,0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId))\n    if (res.result.status === \"success\") {\n      await this.setState({ testInfo: res.result.data })\n      await this.setState({ loading: false })\n      return res.result.data;\n    } else {\n      await this.setState({ testInfo: \"failure\" })\n      await this.setState({ loading: false })\n      return \"failure\"\n    }\n  }\n\n  administerTest = async (pubKey, privKey, chainId, ageGroup, gender, name, surname, dob, id) => {\n    await this.setState({ loading: true })\n    const patientJSON = {\n      name: name,\n      surname: surname,\n      dob: dob,\n      id: id\n    }\n    const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode:`(user.covid.administer-test ${JSON.stringify(pubKey)} ${JSON.stringify(ageGroup)} ${JSON.stringify(gender)} ${JSON.stringify(\"US\")} ${JSON.stringify(\"11249\")} ${JSON.stringify(hash(patientJSON))})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}, {publicKey: pubKey, secretKey: privKey, clist: {name: \"user.covid.REGISTERED-TEST\", args: [pubKey]}}],\n        meta: Pact.lang.mkMeta(\"covid-admin\",chainId,0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId));\n        if (reqKey) {\n          //check kadena tx status every 10 seconds until we get a response (success or fail)\n          var time = 180;\n          var pollRes;\n          while (time > 0) {\n            await this.wait(10000);\n            pollRes = await Pact.fetch.poll({requestKeys: [reqKey.requestKeys[0]]}, createAPIHost(hosts[0], chainId));\n            if (Object.keys(pollRes).length === 0) {\n              console.log('no return poll');\n              console.log(pollRes)\n              time = time - 10\n            } else {\n              console.log(pollRes);\n              time = 0;\n            }\n          }\n          //tx successful\n          if (pollRes[reqKey.requestKeys[0]].result.status === \"success\"){\n            //doc registered on blockchain, now add to db\n            await this.setState({loading: false, txStatus: 'success', txData: pollRes[reqKey.requestKeys[0]]})\n            // alert(\"The test was successfuly registered on Kadena mainnet\")\n            //SHOW A MESSAGE OF SUCCESS\n            // window.location.reload();\n          //tx unsuccessful\n          } else {\n            await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n            // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n            // window.location.reload();\n          }\n        } else {\n          //blockchain call had formatting issues\n          await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n          // alert(\"there was a problem processing your transaction on Kadena mainnet\")\n          // window.location.reload();\n        }\n  }\n\n  endTest = async (pubKey, privKey, chainId, result) => {\n    await this.setState({ loading: true })\n    const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode:`(user.covid.end-test ${JSON.stringify(pubKey)} ${JSON.stringify(result)})`,\n        keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}, {publicKey: pubKey, secretKey: privKey, clist: {name: \"user.covid.REGISTERED-TEST\", args: [pubKey]}}],\n        meta: Pact.lang.mkMeta(\"covid-admin\",chainId,0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800)}, createAPIHost(hosts[0], chainId));\n        if (reqKey) {\n          //check kadena tx status every 10 seconds until we get a response (success or fail)\n          var time = 180;\n          var pollRes;\n          while (time > 0) {\n            await this.wait(10000);\n            pollRes = await Pact.fetch.poll({requestKeys: [reqKey.requestKeys[0]]}, createAPIHost(hosts[0], chainId));\n            if (Object.keys(pollRes).length === 0) {\n              console.log('no return poll');\n              console.log(pollRes)\n              time = time - 10\n            } else {\n              console.log(pollRes);\n              time = 0;\n            }\n          }\n          //tx successful\n          if (pollRes[reqKey.requestKeys[0]].result.status === \"success\"){\n            //doc registered on blockchain, now add to db\n            await this.setState({loading: false, txStatus: 'success', txData: pollRes[reqKey.requestKeys[0]]})\n          //tx unsuccessful\n          } else {\n            await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n          }\n        } else {\n          //blockchain call had formatting issues\n          await this.setState({loading: false, txStatus: 'failure', txData: pollRes[reqKey.requestKeys[0]]})\n        }\n  }\n\n\n  render() {\n    return (\n      <Context.Provider\n        value={{\n          ...this.state,\n          getTest: this.getTest,\n          administerTest: this.administerTest,\n          endTest: this.endTest,\n          setScreen: this.setScreen\n        }}\n      >\n        {this.props.children}\n      </Context.Provider>\n    );\n  }\n\n}\n\nexport default Context;\n"]},"metadata":{},"sourceType":"module"}