{"ast":null,"code":"var _jsxFileName = \"/Users/francescomelpignano/Desktop/kadena/code/covid19-dashboard/src/contexts/PactContext.js\";\nimport React from 'react';\nimport Pact from 'pact-lang-api';\nimport QRCode from 'qrcode';\n\nconst config = require('../config.json');\n\nconst fs = require('fs');\n\nconst Context = React.createContext();\nconst hosts = [\"us1\", \"us2\"];\n\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`;\n\nexport class PactStore extends React.Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      loading: false\n    };\n\n    this.downloadURI = async (uri, name) => {\n      var link = document.createElement(\"a\");\n      link.download = name;\n      link.href = uri;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n    };\n\n    this.generateQR = async text => {\n      try {\n        const qr = await QRCode.toDataURL(text);\n        return qr;\n      } catch (err) {\n        console.error(err);\n      }\n    };\n\n    this.printQRs = async (qrs, brand, model, keysChainArr) => {\n      qrs.map((qr, i) => {\n        console.log(keysChain[i]);\n        this.downloadURI(qr, `${brand}-${model}-${date}-c${keysChainArr[i].chainId}-${keysChainArr[i].publicKey.substring(0, 6)}.png`);\n      });\n    };\n\n    this.wait = async timeout => {\n      return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n      });\n    };\n\n    this.registerTests = async (brand, model, amount, pubKey, privKey) => {\n      await this.setState({\n        loading: true\n      });\n      let pactCode = [];\n      let keysChain = [];\n      let qrs = [];\n      let envData = {}; // envData: {\"doc-ks\": {\"pred\": \"keys-all\", \"keys\": [docKP.publicKey]}},\n\n      for (let i = 0; i < parseInt(amount); i++) {\n        const keypair = Pact.crypto.genKeyPair();\n        const chainId = \"0\"; //change this to be based on the public key\n\n        const qrData = JSON.stringify({ ...keypair,\n          chainId: chainId\n        });\n        keysChain.push(qrData);\n        const qr = await this.generateQR(qrData);\n        qrs.push(qr);\n        pactCode.push(`(user.covid.register-test ${JSON.stringify(pubKey)} ${JSON.stringify(keypair.publicKey)} ${JSON.stringify(i.toString())} ${JSON.stringify(brand)} ${JSON.stringify(model)})`);\n        envData[i] = {\n          \"pred\": \"keys-all\",\n          \"keys\": [keypair.publicKey]\n        };\n      }\n\n      const reqKey = await Pact.fetch.send({\n        networkId: \"testnet04\",\n        pactCode: pactCode.join(\" \"),\n        keyPairs: [{ ...config.covidAdminKeys,\n          clist: {\n            name: \"coin.GAS\",\n            args: []\n          }\n        }, {\n          publicKey: pubKey,\n          secretKey: privKey,\n          clist: {\n            name: \"user.covid.PRINTING-ENTITY\",\n            args: [pubKey]\n          }\n        }],\n        meta: Pact.lang.mkMeta(\"covid-admin\", \"0\", 0.00000001, 10000, Math.round(new Date().getTime() / 1000) - 15, 28800),\n        envData: envData\n      }, createAPIHost(hosts[0], \"0\"));\n\n      if (reqKey) {\n        //check kadena tx status every 10 seconds until we get a response (success or fail)\n        var time = 180;\n        var pollRes;\n\n        while (time > 0) {\n          await this.wait(10000);\n          pollRes = await Pact.fetch.poll({\n            requestKeys: [reqKey.requestKeys[0]]\n          }, createAPIHost(hosts[0], \"0\"));\n\n          if (Object.keys(pollRes).length === 0) {\n            console.log('no return poll');\n            console.log(pollRes);\n            time = time - 10;\n          } else {\n            console.log(pollRes);\n            time = 0;\n          }\n        } //tx successful\n\n\n        if (pollRes[reqKey.requestKeys[0]].result.status === \"success\") {\n          console.log('great success');\n          const date = new Date().toISOString().slice(0, 10);\n          await printQRs(qrs, brand, model, keysChain);\n          await this.setState({\n            loading: false\n          });\n          alert(\"Your test were successfully registered on Kadena mainnet, and QR code labels downloaded\"); //tx unsuccessful\n        } else {\n          console.log(pollRes);\n          await this.setState({\n            loading: false\n          });\n          alert(\"There was a problem processing your transaction on Kadena mainnet. Your tests were not registered\");\n          window.location.reload();\n        }\n      } else {\n        //blockchain call had formatting issues\n        await this.setState({\n          loading: false\n        });\n        alert(\"There was a problem processing your transaction on Kadena mainnet. Your tests were not registered\");\n        window.location.reload();\n      }\n    };\n  }\n\n  render() {\n    return React.createElement(Context.Provider, {\n      value: { ...this.state,\n        registerTests: this.registerTests\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 114\n      },\n      __self: this\n    }, this.props.children);\n  }\n\n}\nexport default Context;","map":{"version":3,"sources":["/Users/francescomelpignano/Desktop/kadena/code/covid19-dashboard/src/contexts/PactContext.js"],"names":["React","Pact","QRCode","config","require","fs","Context","createContext","hosts","createAPIHost","network","chainId","PactStore","Component","state","loading","downloadURI","uri","name","link","document","createElement","download","href","body","appendChild","click","removeChild","generateQR","text","qr","toDataURL","err","console","error","printQRs","qrs","brand","model","keysChainArr","map","i","log","keysChain","date","publicKey","substring","wait","timeout","Promise","resolve","setTimeout","registerTests","amount","pubKey","privKey","setState","pactCode","envData","parseInt","keypair","crypto","genKeyPair","qrData","JSON","stringify","push","toString","reqKey","fetch","send","networkId","join","keyPairs","covidAdminKeys","clist","args","secretKey","meta","lang","mkMeta","Math","round","Date","getTime","time","pollRes","poll","requestKeys","Object","keys","length","result","status","toISOString","slice","alert","window","location","reload","render","props","children"],"mappings":"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","sourcesContent":["import React from 'react';\nimport Pact from 'pact-lang-api';\nimport QRCode from 'qrcode'\nconst config = require('../config.json')\nconst fs = require('fs')\n\nconst Context = React.createContext();\n\n\nconst hosts = [\"us1\", \"us2\"]\nconst createAPIHost = (network, chainId) => `https://${network}.testnet.chainweb.com/chainweb/0.0/testnet04/chain/${chainId}/pact`\n\nexport class PactStore extends React.Component {\n\n  state = {\n    loading: false\n  }\n\n  downloadURI = async (uri, name) => {\n    var link = document.createElement(\"a\");\n    link.download = name;\n    link.href = uri;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  }\n\n  generateQR = async text => {\n    try {\n      const qr = await QRCode.toDataURL(text)\n      return qr\n    } catch (err) {\n      console.error(err)\n    }\n  }\n\n  printQRs = async (qrs, brand, model, keysChainArr) => {\n    qrs.map((qr, i) => {\n      console.log(keysChain[i])\n      this.downloadURI(qr, `${brand}-${model}-${date}-c${keysChainArr[i].chainId}-${keysChainArr[i].publicKey.substring(0, 6)}.png`)\n    })\n  }\n\n  wait = async (timeout) => {\n    return new Promise(resolve => {\n        setTimeout(resolve, timeout);\n    });\n  }\n\n  registerTests = async (brand, model, amount, pubKey, privKey) => {\n    await this.setState({ loading: true })\n    let pactCode = [];\n    let keysChain = [];\n    let qrs = []\n    let envData = {};\n    // envData: {\"doc-ks\": {\"pred\": \"keys-all\", \"keys\": [docKP.publicKey]}},\n    for (let i = 0; i < parseInt(amount); i++) {\n      const keypair = Pact.crypto.genKeyPair();\n      const chainId = \"0\" //change this to be based on the public key\n      const qrData = JSON.stringify({...keypair, chainId: chainId})\n      keysChain.push(qrData);\n      const qr = await this.generateQR(qrData);\n      qrs.push(qr)\n      pactCode.push(`(user.covid.register-test ${JSON.stringify(pubKey)} ${JSON.stringify(keypair.publicKey)} ${JSON.stringify(i.toString())} ${JSON.stringify(brand)} ${JSON.stringify(model)})`)\n      envData[i] = {\"pred\": \"keys-all\", \"keys\": [keypair.publicKey]}\n    }\n    const reqKey = await Pact.fetch.send({\n      networkId: \"testnet04\",\n      pactCode: pactCode.join(\" \"),\n      keyPairs: [{...config.covidAdminKeys, clist: {name: \"coin.GAS\", args: []}}, {publicKey: pubKey, secretKey: privKey, clist: {name: \"user.covid.PRINTING-ENTITY\", args: [pubKey]}}],\n      meta: Pact.lang.mkMeta(\"covid-admin\",\"0\",0.00000001,10000,(Math.round((new Date).getTime()/1000)-15), 28800),\n      envData: envData\n    }, createAPIHost(hosts[0], \"0\"));\n    if (reqKey) {\n      //check kadena tx status every 10 seconds until we get a response (success or fail)\n      var time = 180;\n      var pollRes;\n      while (time > 0) {\n        await this.wait(10000);\n        pollRes = await Pact.fetch.poll({requestKeys: [reqKey.requestKeys[0]]}, createAPIHost(hosts[0], \"0\"));\n        if (Object.keys(pollRes).length === 0) {\n          console.log('no return poll');\n          console.log(pollRes)\n          time = time - 10\n        } else {\n          console.log(pollRes);\n          time = 0;\n        }\n      }\n      //tx successful\n      if (pollRes[reqKey.requestKeys[0]].result.status === \"success\"){\n        console.log('great success')\n        const date = new Date().toISOString().slice(0,10)\n        await printQRs(qrs, brand, model, keysChain);\n        await this.setState({ loading: false })\n        alert(\"Your test were successfully registered on Kadena mainnet, and QR code labels downloaded\")\n      //tx unsuccessful\n      } else {\n        console.log(pollRes)\n        await this.setState({ loading: false })\n        alert(\"There was a problem processing your transaction on Kadena mainnet. Your tests were not registered\")\n        window.location.reload();\n      }\n    } else {\n      //blockchain call had formatting issues\n      await this.setState({ loading: false })\n      alert(\"There was a problem processing your transaction on Kadena mainnet. Your tests were not registered\")\n      window.location.reload();\n    }\n  }\n\n  render() {\n    return (\n      <Context.Provider\n        value={{\n          ...this.state,\n          registerTests: this.registerTests\n        }}\n      >\n        {this.props.children}\n      </Context.Provider>\n    );\n  }\n\n}\n\nexport default Context;\n"]},"metadata":{},"sourceType":"module"}